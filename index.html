<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Espaço Bezerra</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            /* Paleta de Cores Feminina e Suave */
            --primary-color-feminine: #F8B4C4; 
            --secondary-color-feminine: #D8BFD8; 
            --accent-color-feminine: #E6A4B4; 
            --accent-hover-feminine: #E08A9E;
            --rose-gold-accent: #B76E79; 
            
            --text-primary-feminine: #5C3D4C; 
            --text-secondary-feminine: #A0788A; 
            
            --bg-page-feminine: #FFF6F9; 
            --bg-window-feminine: #FFFFFF; 
            --bg-element-feminine: #FDF0F3; 
            
            --border-color-feminine: #EEDDE2; 
            --input-bg-feminine: var(--white);
            --input-border-feminine: var(--border-color-feminine);
            --input-focus-border-feminine: var(--accent-color-feminine);
            
            --shadow-color-feminine: rgba(183, 110, 121, 0.15); 
            --shadow-strong-feminine: rgba(183, 110, 121, 0.22);

            --success-color-feminine: #77DD77; 
            --error-color-feminine: #FF6961;   
            --warning-color-feminine: #FFD700; /* Amarelo para aviso */
            --info-color-feminine: #AEC6CF;    
            --cancel-color: #FFB347; /* Laranja pastel para cancelado */
            --permuta-color: #B28DFF; /* Roxo suave para permuta */
            --star-client-color: #FFC107; /* Dourado para cliente star */


            --font-display: 'Playfair Display', serif; 
            --font-body: 'Poppins', sans-serif;    
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            margin: 0;
            background-color: var(--bg-page-feminine);
            color: var(--text-primary-feminine);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            line-height: 1.6;
            font-size: 15px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: padding 0.3s ease; 
        }

        .container {
            width: 95%;
            max-width: 1100px;
            margin: 25px auto;
            padding: 25px 30px;
            background-color: var(--bg-window-feminine);
            box-shadow: 0 5px 18px var(--shadow-color-feminine);
            border-radius: 16px; 
            border: 1px solid var(--border-color-feminine);
            transition: all 0.3s ease;
        }

        header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color-feminine);
            margin-bottom: 30px;
        }

        header h1 {
            font-family: var(--font-display);
            color: var(--rose-gold-accent);
            font-size: 34px; 
            margin: 0 0 5px 0;
            font-weight: 600;
        }
        header p {
            color: var(--text-secondary-feminine);
            font-size: 16px;
            font-style: italic;
        }

        .login-section, .app-section, .admin-panel-section { display: none; }

        .view-toggle-buttons {
            text-align: center;
            margin-bottom: 20px;
        }
        .view-toggle-buttons button {
            margin: 0 5px;
            font-size: 13px;
            padding: 6px 12px;
        }

        .login-section form {
            display: flex; flex-direction: column; gap: 18px; max-width: 380px;
            margin: 20px auto; 
            padding: 35px; border-radius: 12px;
            background-color: var(--bg-element-feminine);
            border: 1px solid var(--border-color-feminine);
            box-shadow: 0 3px 10px var(--shadow-color-feminine);
        }
        .login-section h2 {
            font-family: var(--font-display); color: var(--rose-gold-accent);
            text-align: center; font-size: 26px; font-weight: 600; margin-bottom: 15px;
        }
        .login-section label {
            font-weight: 500; color: var(--text-primary-feminine);
            font-size: 14px; margin-bottom: 5px; display: block;
        }
        .login-section input[type="text"], .login-section input[type="password"] {
            padding: 12px 14px; border: 1px solid var(--input-border-feminine);
            border-radius: 8px; font-size: 15px; font-family: var(--font-body);
            background-color: var(--input-bg-feminine);
            transition: border-color 0.2s ease, box-shadow 0.2s ease; width: 100%;
        }
        .login-section input[type="text"]:focus, .login-section input[type="password"]:focus {
            border-color: var(--input-focus-border-feminine);
            box-shadow: 0 0 0 3px rgba(230, 164, 180, 0.3); 
            outline: none;
        }
        .login-section button[type="submit"] { 
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--accent-color-feminine), var(--primary-color-feminine));
            color: white; border: none; border-radius: 8px; cursor: pointer;
            font-size: 16px; font-weight: 500;
            transition: background-color 0.2s ease, transform 0.1s ease;
            width: 100%; margin-top: 10px; box-shadow: 0 2px 4px var(--shadow-color-feminine);
        }
        .login-section button[type="submit"]:hover {
            background: linear-gradient(135deg, var(--accent-hover-feminine), var(--primary-color-feminine));
            transform: translateY(-1px);
        }
        #loginError {
            color: var(--error-color-feminine); text-align: center; margin-top: 12px;
            font-size: 14px; font-weight: 500;
        }

        .app-header {
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 12px; margin-bottom: 25px; padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color-feminine);
        }
        .app-header h2 {
            font-family: var(--font-display); color: var(--rose-gold-accent);
            margin: 0; font-size: 26px; font-weight: 600;
        }
        .app-header-actions { display: flex; flex-wrap: wrap; gap: 10px; } 
        
        .std-button-feminine {
            padding: 8px 18px;
            color: var(--rose-gold-accent);
            background-color: transparent;
            border: 1px solid var(--primary-color-feminine);
            border-radius: 20px; 
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease;
            text-align: center;
        }
        .std-button-feminine:hover {
            background-color: rgba(248, 180, 196, 0.15);
            transform: translateY(-1px);
        }
        .std-button-feminine.primary-action { 
            background-color: var(--accent-color-feminine);
            border-color: var(--accent-color-feminine);
            color: white;
            box-shadow: 0 2px 4px var(--shadow-color-feminine);
        }
        .std-button-feminine.primary-action:hover {
            background-color: var(--accent-hover-feminine);
            border-color: var(--accent-hover-feminine);
        }

        .std-button-feminine.danger {
            color: var(--error-color-feminine);
            border-color: var(--error-color-feminine);
        }
        .std-button-feminine.danger:hover {
            background-color: rgba(255, 105, 97, 0.1);
        }
        .std-button-feminine.admin {
            color: var(--secondary-color-feminine); 
            border-color: var(--secondary-color-feminine);
        }
        .std-button-feminine.admin:hover {
            background-color: rgba(216, 191, 216, 0.15);
        }
         .std-button-feminine.admin-main {
            background-color: var(--secondary-color-feminine);
            border-color: var(--secondary-color-feminine);
            color: white;
        }
        .std-button-feminine.admin-main:hover {
            background-color: #c8a2c8; 
        }
        .std-button-feminine.success-button { 
             background-color: var(--success-color-feminine);
             border-color: var(--success-color-feminine);
             color:white;
        }
        .std-button-feminine.success-button:hover{
            background-color: #68d368; 
        }
         .std-button-feminine.info-button {
            color: var(--info-color-feminine);
            border-color: var(--info-color-feminine);
        }
        .std-button-feminine.info-button:hover {
            background-color: rgba(174, 198, 207, 0.15);
        }


        #logoutButton { 
            padding: 8px 18px; color: var(--error-color-feminine); background-color: transparent;
            border: 1px solid var(--error-color-feminine); border-radius: 20px; cursor: pointer;
            font-weight: 500; font-size: 14px; transition: all 0.2s ease;
        }
        #logoutButton:hover { background-color: rgba(255, 105, 97, 0.1); transform: translateY(-1px); }
        
        #adminPanelButton { 
             padding: 8px 18px; color: var(--secondary-color-feminine); background-color: transparent;
             border: 1px solid var(--secondary-color-feminine); border-radius: 20px; cursor: pointer;
             font-weight: 500; font-size: 14px; transition: all 0.2s ease; display: none;
        }
        #adminPanelButton:hover { background-color: rgba(216, 191, 216, 0.15); transform: translateY(-1px); }


        .professional-section h3 { 
            font-family: var(--font-display); color: var(--rose-gold-accent);
            font-size: 22px; font-weight: 600;
            border-bottom: 1px solid var(--border-color-feminine);
            padding-bottom: 8px; margin-top: 0; margin-bottom: 25px;
        }
        .professional-section h4 { 
            font-family: var(--font-body); font-weight: 600; color: var(--text-primary-feminine);
            margin-top: 25px; margin-bottom: 15px; font-size: 18px;
        }
        #appointmentForm, #changePasswordSection { 
            background-color: var(--bg-element-feminine); padding: 25px;
            border-radius: 12px; margin-bottom: 30px;
            border: 1px solid var(--border-color-feminine);
        }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-grid-full-width { grid-column: 1 / -1; } 

        .form-grid label, #changePasswordSection label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; color: var(--text-primary-feminine); }
        .form-grid input[type="text"], .form-grid input[type="date"], .form-grid input[type="time"], 
        .form-grid select, .form-grid textarea, .form-grid input[type="number"],
        #changePasswordSection input[type="password"] {
            width: 100%; padding: 10px 14px; border: 1px solid var(--input-border-feminine);
            border-radius: 8px; box-sizing: border-box; font-family: var(--font-body);
            font-size: 15px; background-color: var(--input-bg-feminine);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-grid input:focus, .form-grid select:focus, .form-grid textarea:focus,
        #changePasswordSection input[type="password"]:focus {
            border-color: var(--input-focus-border-feminine);
            box-shadow: 0 0 0 3px rgba(230, 164, 180, 0.3);
            outline: none;
        }
        
        .form-grid textarea { resize: vertical; min-height: 90px; }
        
        #proceduresCheckboxesContainer {
            max-height: 150px; overflow-y: auto; padding: 10px;
            border: 1px solid var(--input-border-feminine); border-radius: 8px;
            background-color: var(--input-bg-feminine); margin-bottom: 10px;
        }
        .procedure-checkbox-item { display: block; margin-bottom: 8px; }
        .procedure-checkbox-item input[type="checkbox"] { margin-right: 8px; accent-color: var(--accent-color-feminine); transform: scale(1.1); }
        .procedure-checkbox-item label { font-weight: normal; font-size: 14px; display: inline; }
        .procedure-checkbox-item .procedure-value-text { font-size: 0.9em; color: var(--text-secondary-feminine); margin-left: 5px;}

        .payment-options-container { margin-top: 15px; padding-top:15px; border-top: 1px dashed var(--border-color-feminine); }
        .payment-options-container > div { margin-bottom: 10px; }
        .payment-options-container input[type="checkbox"] { margin-right: 8px; accent-color: var(--accent-color-feminine); transform: scale(1.1); }
        .payment-options-container label { font-weight: 500; font-size: 14px; display: inline; }
        .payment-options-container input[type="number"], .payment-options-container textarea { margin-top: 5px; }
        #permutaDetailsContainer, #naoCobrarAdiantamentoContainer { display: none; margin-top: 10px; }
        #permutaDetailsContainer { padding-left: 20px; border-left: 3px solid var(--permuta-color); }


        #totalAgendamentoValueDisplay { 
            font-size: 15px; color: var(--rose-gold-accent); margin-top: 10px; font-weight: bold; 
            display: block; text-align: right; padding: 5px 0;
        }
        
        .appointments-list { margin-top: 30px; }
        .appointment-item {
            background-color: var(--bg-window-feminine); padding: 18px; border-radius: 10px;
            margin-bottom: 14px; border: 1px solid var(--border-color-feminine);
            box-shadow: 0 2px 6px var(--shadow-color-feminine);
            display: flex; justify-content: space-between; align-items: flex-start;
            flex-wrap: wrap; transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .appointment-item:hover { transform: translateY(-2px); box-shadow: 0 4px 10px var(--shadow-strong-feminine); }
        
        .appointment-item.concluido { border-left: 5px solid var(--success-color-feminine); background-color: #f2fff2; }
        .appointment-item.concluido .appointment-details p,
        .appointment-item.concluido .appointment-details strong { text-decoration: line-through; color: var(--text-secondary-feminine); }
        .appointment-item.cancelado { border-left: 5px solid var(--cancel-color); background-color: #fffaf0; }
        .appointment-item.cancelado .appointment-details p,
        .appointment-item.cancelado .appointment-details strong { text-decoration: line-through; color: var(--text-secondary-feminine); }
        .appointment-item.permuta { border-left: 5px solid var(--permuta-color); background-color: #f5f0ff; }
        .appointment-item.star-client-discount { border-right: 5px solid var(--star-client-color); }


        .appointment-details { flex-grow: 1; padding-right: 15px; }
        .appointment-item p { margin: 4px 0 7px 0; font-size: 14px; color: var(--text-primary-feminine); }
        .appointment-item p strong { font-weight: 600; }
        .appointment-item .procedure-list-display { list-style: disc; margin-left: 20px; padding-left: 0;}
        .appointment-item .procedure-list-display li { font-size: 14px; color: var(--rose-gold-accent); }
        .appointment-item .procedure-list-display .procedure-value-text { font-size: 0.9em; color: var(--text-secondary-feminine); }
        .appointment-item .total-value-display { font-weight: bold; margin-top: 5px; color: var(--rose-gold-accent); }
        .appointment-item .discount-info, .appointment-item .permuta-info, .appointment-item .star-client-info { 
            font-style: italic; color: var(--accent-color-feminine); font-size: 0.9em; margin-top:3px; 
        }
        .appointment-item .permuta-info strong { color: var(--permuta-color); }
        .appointment-item .star-client-info strong { color: var(--star-client-color); }
        
        .appointment-actions { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 8px; }
        .appointment-item button { 
            padding: 6px 12px; border: 1px solid transparent; border-radius: 15px;
            cursor: pointer; font-size: 13px; font-weight: 500;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease;
        }
        .appointment-item button:hover { transform: translateY(-1px); }
        .appointment-item button:disabled { opacity: 0.6; cursor: not-allowed; background-color: var(--bg-element-feminine) !important; color:var(--text-secondary-feminine) !important; border-color: var(--border-color-feminine) !important; }

        .appointment-item .edit-btn { color: var(--rose-gold-accent); background-color: rgba(183, 110, 121, 0.1); }
        .appointment-item .edit-btn:hover { background-color: rgba(183, 110, 121, 0.2); }
        .appointment-item .delete-btn { color: var(--error-color-feminine); background-color: rgba(255, 105, 97, 0.1); }
        .appointment-item .delete-btn:hover { background-color: rgba(255, 105, 97, 0.2); }
        .appointment-item .pdf-btn { color: var(--info-color-feminine); background-color: rgba(174, 198, 207, 0.15); }
        .appointment-item .pdf-btn:hover { background-color: rgba(174, 198, 207, 0.25); }
        
        .appointment-item .toggle-concluido-btn { color: var(--success-color-feminine); background-color: rgba(119, 221, 119, 0.15); }
        .appointment-item .toggle-concluido-btn:hover { background-color: rgba(119, 221, 119, 0.25); }
        .appointment-item .toggle-concluido-btn.concluido { background-color: var(--success-color-feminine); color: white; }
        .appointment-item .toggle-concluido-btn.concluido:hover { background-color: #68d368; }

        .appointment-item .toggle-cancelado-btn { color: var(--cancel-color); background-color: rgba(255, 179, 71, 0.15); }
        .appointment-item .toggle-cancelado-btn:hover { background-color: rgba(255, 179, 71, 0.25); }
        .appointment-item .toggle-cancelado-btn.cancelado { background-color: var(--cancel-color); color: var(--text-primary-feminine); }
        .appointment-item .toggle-cancelado-btn.cancelado:hover { background-color: #f0a030; }


        /* Relatório de Ganhos */
        .report-controls-container { margin-bottom: 15px; display:flex; flex-wrap:wrap; gap:10px; align-items:center;}
        .report-controls-container label { font-weight: 500; }
        .report-controls-container input[type="month"], .report-controls-container input[type="date"], .report-controls-container select {
            padding: 8px 10px; border: 1px solid var(--input-border-feminine); border-radius: 8px;
            font-family: var(--font-body); font-size: 14px;
        }
        #reportSection { margin-top: 20px; padding: 20px; background-color: var(--bg-element-feminine); border-radius: 10px; border: 1px solid var(--border-color-feminine); }
        #reportSection h5 { color: var(--rose-gold-accent); font-size: 18px; font-weight: 600; margin-top:0; margin-bottom:15px; }
        #reportSection table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; border: 1px solid var(--border-color-feminine); border-radius: 8px; overflow:hidden; }
        #reportSection th, #reportSection td { padding: 10px 14px; text-align: left; font-size: 14px; border-bottom: 1px solid var(--border-color-feminine); }
        #reportSection th { background-color: rgba(248, 180, 196, 0.15); font-weight: 600; color: var(--rose-gold-accent); }
        #reportSection tr:last-child td { border-bottom: none; }
        #reportSection .total-ganhos { font-weight: 600; font-size: 17px; margin-top: 18px; text-align: right; color: var(--rose-gold-accent); }
        #reportSection .permuta-item td { font-style: italic; color: var(--text-secondary-feminine); }


        #changePasswordSection { display:none; margin-top: 30px;}
        #changePasswordSection h4 {font-family: var(--font-body); font-weight: 600; color: var(--text-primary-feminine); font-size: 18px; margin-bottom: 15px;}
        #changePasswordForm div { margin-bottom: 15px; }
        #changePasswordStatus { margin-top:15px; font-weight:500; font-size: 14px; }
        #changePasswordStatus.success { color: var(--success-color-feminine); }
        #changePasswordStatus.error { color: var(--error-color-feminine); }


        /* Painel do Administrador Feminino */
        .admin-panel-section { padding: 25px; background-color: var(--bg-window-feminine); border-radius: 12px; margin-top: 20px; border: 1px solid var(--border-color-feminine); }
        .admin-panel-section h3 { 
            font-family: var(--font-display); color: var(--secondary-color-feminine);
            text-align: center; font-size: 26px; font-weight: 600; margin-bottom: 30px;
        }
        .admin-section { 
            margin-bottom: 28px; padding: 20px; background-color: var(--bg-element-feminine);
            border-radius: 10px; border: 1px solid var(--border-color-feminine);
        }
        .admin-section h4 { 
            font-family: var(--font-body); font-weight: 600; color: var(--rose-gold-accent);
            margin-top: 0; margin-bottom: 18px; font-size: 18px;
        }
        .admin-section label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; color: var(--text-primary-feminine); }
        .admin-section input[type="text"], .admin-section input[type="password"], 
        .admin-section input[type="number"], .admin-section select {
            width: 100%; padding: 10px 14px; border-radius: 8px;
            border: 1px solid var(--input-border-feminine); margin-bottom: 12px;
            font-size: 15px; font-family: var(--font-body); background-color: var(--input-bg-feminine);
        }
        .admin-section input:focus, .admin-section select:focus {
            border-color: var(--input-focus-border-feminine);
            box-shadow: 0 0 0 3px rgba(230, 164, 180, 0.3); outline: none;
        }
        .admin-section select {
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2220%22%20height%3D%2220%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M5%208l5%205%205-5z%22%20fill%3D%22%23A0788A%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat; background-position: right 12px center;
            background-size: 12px; padding-right: 35px;
        }
        .admin-section button { 
            margin-right: 8px; margin-top: 5px;
        }
        
        .admin-section ul { list-style: none; padding: 0; }
        .admin-section li {
            background-color: var(--bg-window-feminine); padding: 12px 15px; margin-bottom: 10px;
            border-radius: 8px; display: flex; justify-content: space-between;
            align-items: center; flex-wrap: wrap; gap: 10px;
            border: 1px solid var(--border-color-feminine);
        }
        .admin-section li > span:first-child { font-weight: 500; flex-basis: 200px; flex-grow: 1;}
        .admin-section li div { display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; }
        .admin-section .procedure-item input[type="number"] { width: 90px; margin-left: 0; margin-bottom: 0; }
        #adminLogoutButton { display:block; margin: 25px auto 0 auto; width: fit-content; }


        #statusMessage, #adminStatusMessage {
            padding: 12px 18px; text-align: center; font-weight: 500;
            border-radius: 8px; margin: 18px auto; display: none;
            max-width: 90%; font-size: 14px; border: 1px solid transparent;
            box-shadow: 0 2px 5px var(--shadow-color-feminine);
        }
        #statusMessage.success, #adminStatusMessage.success { background-color: rgba(119, 221, 119, 0.2); color: #4b844b; border-color: rgba(119, 221, 119, 0.4); }
        #statusMessage.error, #adminStatusMessage.error { background-color: rgba(255, 105, 97, 0.15); color: var(--error-color-feminine); border-color: rgba(255, 105, 97, 0.3); }
        #statusMessage.info, #adminStatusMessage.info { background-color: rgba(174, 198, 207, 0.2); color: #5a788a; border-color: rgba(174, 198, 207, 0.4); }

        body.mobile-view-active {
            font-size: 16px; 
            padding: 0; 
        }
        body.mobile-view-active .container {
            width: 100%; max-width: 100%; margin: 0; padding: 15px; 
            border-radius: 0; box-shadow: none; border-left: none; border-right: none;
        }
        body.mobile-view-active header h1 { font-size: 28px; }
        body.mobile-view-active header p { font-size: 15px; }
        body.mobile-view-active .login-section form {
            max-width: 100%; padding: 20px; margin: 10px auto;
            box-shadow: none; border: none; background-color: var(--bg-window-feminine);
        }
        body.mobile-view-active .app-header { flex-direction: column; align-items: flex-start; }
        body.mobile-view-active .app-header-actions { width: 100%; margin-top:10px; justify-content: space-around; }
        body.mobile-view-active .app-header-actions button { flex-grow: 1; margin-bottom: 5px; } 
        
        body.mobile-view-active .form-grid { grid-template-columns: 1fr; }
        body.mobile-view-active #proceduresCheckboxesContainer { max-height: 200px; }

        body.mobile-view-active .appointment-item { flex-direction: column; align-items: stretch; }
        body.mobile-view-active .appointment-actions { 
            flex-direction: column; 
            align-items: stretch; 
            margin-left: 0; 
            margin-top: 15px; 
            width: 100%; 
        }
        body.mobile-view-active .appointment-actions button { 
            margin-bottom: 8px; 
            padding: 10px 12px; 
        }
        body.mobile-view-active .appointment-actions button:last-child { margin-bottom: 0; }
        
        body.mobile-view-active .admin-section { padding: 15px; }
        body.mobile-view-active .admin-section li { flex-direction: column; align-items: flex-start;}
        body.mobile-view-active .admin-section li div { margin-top: 8px; width: 100%; display: flex; flex-direction: column; gap: 8px; }
        body.mobile-view-active .admin-section li div input[type="text"],
        body.mobile-view-active .admin-section li div input[type="number"] { width: 100%; max-width: none; }
        body.mobile-view-active .admin-section li div button { width: 100%; margin-left: 0 !important;}

        body.mobile-view-active #addProcedureToProfessionalForm { flex-direction: column; align-items: stretch;}
        body.mobile-view-active #addProcedureToProfessionalForm div { width: 100%; }
        body.mobile-view-active #addProcedureToProfessionalForm button { width: 100%; margin-top: 10px; }
        body.mobile-view-active .report-controls-container {flex-direction:column; align-items:stretch;}
        body.mobile-view-active .report-controls-container > * {width:100%; margin-bottom:10px;}


        @media (max-width: 768px) { 
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-element-feminine); }
        ::-webkit-scrollbar-thumb { background: var(--primary-color-feminine); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color-feminine); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Espaço Bezerra</h1>
            <p>Sua beleza, nosso compromisso.</p>
        </header>

        <section id="loginSection" class="login-section">
            <div class="view-toggle-buttons">
                <button id="switchToMobileViewButton" class="std-button-feminine">Ver no Celular</button>
                <button id="switchToDesktopViewButton" class="std-button-feminine" style="display:none;">Ver no Desktop</button>
            </div>
            <form id="loginForm">
                <h2>Acessar Agenda</h2>
                <div>
                    <label for="username">Usuário:</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div>
                    <label for="password">Senha:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit">Entrar</button>
                <p id="loginError"></p>
            </form>
        </section>

        <section id="appSection" class="app-section">
            <div class="app-header">
                <h2 id="welcomeMessage">Bem-vinda!</h2>
                <div class="app-header-actions">
                    <button id="adminPanelButton" class="std-button-feminine admin">Painel Admin</button>
                    <button id="logoutButton" class="std-button-feminine danger">Sair</button>
                </div>
            </div>
            <div id="statusMessage"></div>
            <div id="professionalWorkspace" class="professional-section">
                </div>
        </section>

        <section id="adminPanelSection" class="admin-panel-section">
            <h3>Painel do Administrador</h3>
            <div id="adminStatusMessage"></div>

            <div class="admin-section">
                <h4>Gerenciar Profissionais</h4>
                <div id="manageProfessionalsContainer">
                    </div>
                <hr style="margin: 25px 0; border-color: var(--border-color-feminine);">
                <h5>Adicionar Nova Profissional</h5>
                <form id="addProfessionalForm">
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div><label for="newProfId">ID (Login):</label><input type="text" id="newProfId" required></div>
                        <div><label for="newProfFullName">Nome Completo:</label><input type="text" id="newProfFullName" required></div>
                        <div><label for="newProfPassword">Senha Inicial:</label><input type="password" id="newProfPassword" required></div>
                        <div><label for="newProfArea">Área:</label>
                            <select id="newProfArea" required>
                                <option value="Unhas">Unhas</option>
                                <option value="Sobrancelhas e Cílios">Sobrancelhas e Cílios</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="std-button-feminine admin-main success-button">Adicionar Profissional</button>
                </form>
            </div>

            <div class="admin-section">
                <h4>Gerenciar Procedimentos e Valores</h4>
                <label for="selectProfessionalForProcedures">Selecionar Profissional:</label>
                <select id="selectProfessionalForProcedures" style="margin-bottom: 15px;"></select>
                <div id="manageProceduresContainer">
                    </div>
                <h5 style="margin-top:20px;">Adicionar Novo Procedimento</h5>
                <form id="addProcedureToProfessionalForm" style="display: flex; gap: 12px; align-items: flex-end; flex-wrap:wrap;">
                    <div style="flex-grow:1;"><label for="newProcedureName">Nome do Procedimento:</label><input type="text" id="newProcedureName" required></div>
                    <div style="width:120px;"><label for="newProcedureValue">Valor (R$):</label><input type="number" id="newProcedureValue" step="0.01" min="0" value="0.00" required></div>
                    <button type="submit" class="std-button-feminine admin-main success-button" style="height: 42px; margin-bottom:12px;">Adicionar</button>
                </form>
            </div>

            <div class="admin-section">
                <h4>Backup e Configurações Avançadas</h4>
                <button id="exportDataButton" class="std-button-feminine admin">Exportar Backup (JSON)</button>
                <div style="margin-top:15px;">
                    <label for="importDataFile" style="display:block; margin-bottom:8px;">Carregar Backup (JSON):</label>
                    <input type="file" id="importDataFile" accept=".json" style="margin-bottom:8px; display:block; font-size:13px;">
                    <button id="importDataButton" class="std-button-feminine danger">Importar e Substituir Dados</button>
                </div>
                <hr style="margin: 20px 0; border-color: var(--border-color-feminine);">
                <button id="clearCacheButtonAdmin" class="std-button-feminine danger">Limpar Todos os Dados (Reset App)</button>
            </div>
             <button id="adminLogoutButton" class="std-button-feminine danger" style="margin: 25px auto 0 auto; display:block; width: fit-content;">Sair do Painel (Logout)</button>
        </section>
    </div>

    <script>
        const APP_DATA_KEY = 'espacoBezerraAppData_v13_star_reports_fixed'; 
        const VIEW_MODE_KEY = 'espacoBezerraViewMode';

        function getInitialProfessionalsData() {
            return {
                "Philippe": { 
                    id: "Philippe", password: "88778784", fullName: "Philippe (Admin)",
                    area: "Administração", isAdmin: true, procedures: []
                },
                "Denefer": { 
                    id: "Denefer", password: "1234", fullName: "Denefer Bezerra",
                    area: "Sobrancelhas e Cílios", isAdmin: false,
                    procedures: [
                        { name: "Design de Sobrancelhas (Pinça)", value: 45.00 },
                        { name: "Design de Sobrancelhas com Henna", value: 65.00 },
                        { name: "Design de Sobrancelhas com Tintura", value: 70.00 },
                        { name: "Brow Lamination", value: 160.00 },
                        { name: "Lash Lifting (Lifting de Cílios)", value: 140.00 },
                        { name: "Tintura de Cílios", value: 45.00 },
                        { name: "Extensão de Cílios (Volume Brasileiro)", value: 180.00 },
                        { name: "Manutenção Extensão de Cílios (até 21 dias)", value: 100.00 },
                        { name: "Micropigmentação Sobrancelha (Fio a Fio)", value: 480.00 },
                        { name: "Micropigmentação Sobrancelha (Shadow)", value: 450.00 },
                        { name: "Micropigmentação Labial (Revitalização)", value: 500.00 },
                        { name: "Despigmentação de Sobrancelhas (Sessão)", value: 250.00 },
                        { name: "Limpeza de Pele Simples", value: 100.00 },
                        { name: "Limpeza de Pele com Peeling de Diamante", value: 150.00 },
                        { name: "Protocolo Glow Lips", value: 120.00 },
                        { name: "Remoção de Extensão de Cílios", value: 50.00 },
                        { name: "Hidratação Facial Profunda", value: 130.00 },
                        { name: "Epilação Egípcia (Buço)", value: 25.00 },
                        { name: "Epilação Egípcia (Rosto Completo)", value: 70.00 }
                    ]
                },
                "Deisyane": { 
                    id: "Deisyane", password: "1234", fullName: "Deisyane Bezerra",
                    area: "Unhas", isAdmin: false,
                    procedures: [
                        { name: "Manicure Simples (Pé e Mão)", value: 50.00 },
                        { name: "Manicure (Mão)", value: 28.00 },
                        { name: "Pedicure (Pé)", value: 35.00 },
                        { name: "Esmaltação em Gel (Mão OU Pé)", value: 65.00 },
                        { name: "Esmaltação em Gel (Mão E Pé)", value: 120.00 },
                        { name: "Spa dos Pés (comum)", value: 60.00 },
                        { name: "Spa dos Pés (completo com hidratação profunda)", value: 85.00 },
                        { name: "Alongamento Fibra de Vidro (1ª aplicação)", value: 200.00 },
                        { name: "Manutenção Fibra de Vidro (até 21 dias)", value: 110.00 },
                        { name: "Alongamento em Gel Moldado (1ª aplicação)", value: 190.00 },
                        { name: "Manutenção Gel Moldado (até 21 dias)", value: 100.00 },
                        { name: "Blindagem de Unhas (Banho de Gel/Acrílico)", value: 80.00 },
                        { name: "Remoção de Alongamento (com tratamento)", value: 60.00 },
                        { name: "Decoração Artística (simples, por unha)", value: 5.00 },
                        { name: "Decoração Artística (complexa, por unha)", value: 10.00 },
                        { name: "Unha Encravada (tratamento simples)", value: 40.00 },
                        { name: "Plástica dos Pés", value: 90.00 },
                        { name: "Reconstrução de Unha (por unha)", value: 20.00 },
                        { name: "Esmaltação Infantil (Mão ou Pé)", value: 15.00 },
                        { name: "Cutilagem Russa (Manicure)", value: 40.00 }
                    ]
                }
            };
        }

        let loggedInUser = null;
        let appData = { professionals: {}, appointments: [] };

        const loginSection = document.getElementById('loginSection');
        const appSection = document.getElementById('appSection');
        const adminPanelSection = document.getElementById('adminPanelSection');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const logoutButton = document.getElementById('logoutButton');
        const adminPanelButton = document.getElementById('adminPanelButton');
        const clearCacheButtonAdmin = document.getElementById('clearCacheButtonAdmin');
        const professionalWorkspace = document.getElementById('professionalWorkspace');
        const statusMessage = document.getElementById('statusMessage');
        const adminStatusMessage = document.getElementById('adminStatusMessage');
        const adminLogoutButton = document.getElementById('adminLogoutButton');
        const switchToMobileViewButton = document.getElementById('switchToMobileViewButton');
        const switchToDesktopViewButton = document.getElementById('switchToDesktopViewButton');


        function setViewMode(mode) { 
            if (mode === 'mobile') {
                document.body.classList.add('mobile-view-active');
                switchToMobileViewButton.style.display = 'none';
                switchToDesktopViewButton.style.display = 'inline-block';
                localStorage.setItem(VIEW_MODE_KEY, 'mobile');
            } else {
                document.body.classList.remove('mobile-view-active');
                switchToMobileViewButton.style.display = 'inline-block';
                switchToDesktopViewButton.style.display = 'none';
                localStorage.setItem(VIEW_MODE_KEY, 'desktop');
            }
        }

        function loadViewModePreference() {
            const preferredMode = localStorage.getItem(VIEW_MODE_KEY);
            setViewMode(preferredMode === 'mobile' ? 'mobile' : 'desktop');
        }

        switchToMobileViewButton.addEventListener('click', () => setViewMode('mobile'));
        switchToDesktopViewButton.addEventListener('click', () => setViewMode('desktop'));


        function loadAppDataFromLocalStorage() {
            const storedData = localStorage.getItem(APP_DATA_KEY);
            if (storedData) {
                try {
                    const parsedData = JSON.parse(storedData);
                    if (parsedData && typeof parsedData.professionals === 'object' && Array.isArray(parsedData.appointments)) {
                        appData = parsedData;
                        Object.values(appData.professionals).forEach(prof => {
                            if (!Array.isArray(prof.procedures)) prof.procedures = [];
                            prof.procedures = prof.procedures.map(p => 
                                typeof p === 'string' ? { name: p, value: 0.00 } : (p && p.name !== undefined && p.value !== undefined ? p : { name: "Procedimento Inválido", value: 0.00 })
                            );
                        });
                        appData.appointments = appData.appointments.map(a => ({ 
                            ...a, 
                            procedures: Array.isArray(a.procedures) ? a.procedures : (a.procedure ? [{name: a.procedure, value: a.procedureValue || 0.00}] : []),
                            totalValue: a.totalValue !== undefined ? Number(a.totalValue) : 0,
                            isStarClient: a.isStarClient || false, 
                            discountPercentage: a.discountPercentage !== undefined ? Number(a.discountPercentage) : 0,
                            isPermuta: a.isPermuta || false,
                            permutaValorEstimado: a.permutaValorEstimado !== undefined ? Number(a.permutaValorEstimado) : 0,
                            permutaDescricao: a.permutaDescricao || "",
                            naoCobrarAdiantamento: a.naoCobrarAdiantamento || false, 
                            finalValue: a.finalValue !== undefined ? Number(a.finalValue) : 0, 
                            concluido: a.concluido || false,
                            cancelado: a.cancelado || false
                        }));
                        appData.appointments.forEach(a => recalculateFinalValue(a)); 

                    } else {
                        initializeAppDefaultData();
                    }
                } catch (e) {
                    console.error("Erro ao parsear dados:", e);
                    initializeAppDefaultData();
                }
            } else {
                initializeAppDefaultData();
            }
        }
        
        function recalculateFinalValue(appointment) {
            const rawTotal = (appointment.procedures || []).reduce((sum, p) => sum + Number(p.value || 0), 0);
            appointment.totalValue = rawTotal;
            
            let valueAfterStarDiscount = rawTotal;
            if (appointment.isStarClient && !appointment.isPermuta) { // Desconto Star não se aplica a permutas
                valueAfterStarDiscount = rawTotal * 0.80; // 20% de desconto Star
            }

            if (appointment.isPermuta) {
                appointment.finalValue = 0;
                // O discountPercentage já deve ser 0 se for permuta, mas garantimos aqui
                appointment.discountPercentage = 0; 
            } else {
                const discountAmount = valueAfterStarDiscount * (Number(appointment.discountPercentage || 0) / 100);
                appointment.finalValue = valueAfterStarDiscount - discountAmount;
            }
        }


        function initializeAppDefaultData() {
            appData.professionals = getInitialProfessionalsData();
            appData.appointments = [];
            saveAppDataToLocalStorage();
        }

        function saveAppDataToLocalStorage() {
            try {
                localStorage.setItem(APP_DATA_KEY, JSON.stringify(appData));
            } catch (e) {
                console.error("Erro ao salvar dados:", e);
                showStatusMessage("Erro crítico ao salvar dados! Verifique o console.", "error", true);
                if (e.name === 'QuotaExceededError') {
                    alert('ERRO: Armazenamento local do navegador está cheio!');
                }
            }
        }

        function showStatusMessage(message, type = 'info', isAdminMessage = false) {
            const target = isAdminMessage ? adminStatusMessage : statusMessage;
            target.textContent = message;
            target.className = '';
            target.classList.add(type);
            target.style.display = 'block';
            setTimeout(() => { target.style.display = 'none'; }, 3500);
        }

        loginForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const username = loginForm.username.value;
            const password = loginForm.password.value;
            loginError.textContent = '';
            const professional = appData.professionals[username];
            if (professional && professional.password === password) { 
                loggedInUser = professional;
                if (professional.isAdmin) showAdminPanel();
                else showAppSection();
            } else {
                loginError.textContent = "Usuário ou senha inválidos.";
            }
        });
        
        function performLogout() {
            loggedInUser = null;
            showLoginSection();
        }

        logoutButton.addEventListener('click', performLogout);
        adminLogoutButton.addEventListener('click', performLogout);


        function showLoginSection() {
            loginSection.style.display = 'block';
            appSection.style.display = 'none';
            adminPanelSection.style.display = 'none';
            adminPanelButton.style.display = 'none';
            loadViewModePreference(); 
        }

        function showAppSection() {
            loginSection.style.display = 'none';
            appSection.style.display = 'block';
            adminPanelSection.style.display = 'none';
            welcomeMessage.textContent = `${loggedInUser.fullName}`;
            adminPanelButton.style.display = loggedInUser.isAdmin ? 'inline-block' : 'none';
            renderProfessionalWorkspace();
        }
        
        function showAdminPanel() {
            loginSection.style.display = 'none';
            appSection.style.display = 'none';
            adminPanelSection.style.display = 'block';
            adminPanelButton.style.display = 'none'; 
            populateAdminPanel();
        }

        adminPanelButton.addEventListener('click', () => {
            if (loggedInUser && loggedInUser.isAdmin) showAdminPanel();
        });
        
        if (clearCacheButtonAdmin) { 
            clearCacheButtonAdmin.addEventListener('click', () => {
                if (confirm("ATENÇÃO: Esta ação excluirá TODOS os dados de agendamentos e profissionais salvos localmente no seu navegador. Esta ação não pode ser desfeita.\n\nDeseja continuar?")) {
                    localStorage.removeItem(APP_DATA_KEY);
                    initializeAppDefaultData(); 
                    performLogout(); 
                    alert("Os dados locais foram limpos. A aplicação foi redefinida para o estado inicial.");
                }
            });
        }


        function renderProfessionalWorkspace() {
            if (!loggedInUser || loggedInUser.isAdmin) {
                professionalWorkspace.innerHTML = loggedInUser && loggedInUser.isAdmin ? "" : "<p style='text-align:center; padding: 20px; color:var(--text-secondary-feminine);'>Acesse o Painel Admin ou faça login como profissional.</p>";
                return;
            }

            professionalWorkspace.innerHTML = `
                <h3>${loggedInUser.area}</h3>
                <div style="margin-bottom: 20px; display:flex; flex-wrap:wrap; gap:10px;">
                    <button id="showChangePasswordFormButton" class="std-button-feminine">Alterar Senha</button>
                    <button id="generateReportButton" class="std-button-feminine primary-action" style="margin-left:10px;">Relatório de Ganhos</button>
                </div>
                <div id="reportControlsContainer" style="display:none;" class="report-controls-container">
                    <label for="reportType">Tipo:</label>
                    <select id="reportType" class="std-button-feminine" style="padding: 8px 12px;">
                        <option value="diario">Diário</option>
                        <option value="mensal">Mensal</option>
                        <option value="total" selected>Total</option>
                    </select>
                    <input type="date" id="reportDateInput" style="display:none;">
                    <input type="month" id="reportMonthInput" style="display:none;">
                    <button id="downloadReportPdfButton" class="std-button-feminine info-button">Baixar PDF do Relatório</button>
                </div>
                <div id="changePasswordSectionInternal" style="display:none; margin-bottom: 20px; padding: 20px; background-color: var(--bg-element-feminine); border-radius: 10px; border: 1px solid var(--border-color-feminine);">
                    <h4>Alterar Senha</h4>
                    <form id="changePasswordFormInternal">
                        <div><label for="currentPassword">Senha Atual:</label><input type="password" id="currentPassword" required></div>
                        <div style="margin-top:10px;"><label for="newPassword">Nova Senha:</label><input type="password" id="newPassword" required></div>
                        <div style="margin-top:10px;"><label for="confirmNewPassword">Confirmar Nova Senha:</label><input type="password" id="confirmNewPassword" required></div>
                        <button type="submit" class="std-button-feminine primary-action" style="margin-top:15px;">Salvar Nova Senha</button>
                        <p id="changePasswordStatus" style="margin-top:10px; font-weight:500;"></p>
                    </form>
                </div>
                <div id="reportSection" style="display:none;"></div>
                <h4>Novo Agendamento</h4>
                <form id="appointmentFormInternal">
                    <div class="form-grid">
                        <div><label for="clientName">Nome Cliente:</label><input type="text" id="clientName" required></div>
                        <div><label for="appointmentDate">Data:</label><input type="date" id="appointmentDate" required></div>
                        <div><label for="appointmentTime">Hora:</label><input type="time" id="appointmentTime" required></div>
                        
                        <div class="form-grid-full-width">
                            <label>Procedimentos:</label>
                            <div id="proceduresCheckboxesContainer"></div>
                        </div>
                        <div class="payment-options-container form-grid-full-width">
                            <div>
                                <input type="checkbox" id="isStarClientCheckbox" name="isStarClient">
                                <label for="isStarClientCheckbox">✨ Minha Cliente é uma Star! (20% desc.)</label>
                            </div>
                            <div>
                                <label for="discountPercentage">Desconto Adicional (%):</label>
                                <input type="number" id="discountPercentage" name="discountPercentage" min="0" max="100" value="0" style="width: 80px; display: inline-block; margin-right: 10px;">
                            </div>
                            <div>
                                <input type="checkbox" id="isPermutaCheckbox" name="isPermuta">
                                <label for="isPermutaCheckbox">Serviço é Permuta?</label>
                            </div>
                            <div id="permutaDetailsContainer">
                                <div><label for="permutaValorEstimado">Valor Estimado da Permuta (R$):</label><input type="number" id="permutaValorEstimado" name="permutaValorEstimado" min="0" step="0.01"></div>
                                <div><label for="permutaDescricao">Descrição da Troca/Permuta:</label><textarea id="permutaDescricao" name="permutaDescricao" rows="2"></textarea></div>
                            </div>
                             <div id="naoCobrarAdiantamentoContainer" style="margin-top:10px;">
                                <input type="checkbox" id="naoCobrarAdiantamentoCheckbox" name="naoCobrarAdiantamento">
                                <label for="naoCobrarAdiantamentoCheckbox">Não cobrar adiantamento para este agendamento</label>
                            </div>
                        </div>
                        <div class="form-grid-full-width" id="totalAgendamentoValueDisplay">Valor Total: R$ 0.00</div>
                        <div class="form-grid-full-width"><label for="notes">Observações:</label><textarea id="notes"></textarea></div>
                    </div>
                    <input type="hidden" id="editingAppointmentId">
                    <button type="submit" id="saveAppointmentButtonInternal" class="std-button-feminine primary-action">Salvar Agendamento</button>
                </form>
                <div class="appointments-list">
                    <h4>Seus Agendamentos</h4>
                    <div id="appointmentsContainerInternal"></div>
                </div>
            `;
            
            document.getElementById('showChangePasswordFormButton').addEventListener('click', () => {
                const formSection = document.getElementById('changePasswordSectionInternal');
                formSection.style.display = formSection.style.display === 'none' ? 'block' : 'none';
                if(formSection.style.display === 'block') formSection.scrollIntoView({behavior: 'smooth', block: 'nearest'});
                document.getElementById('changePasswordStatus').textContent = '';
            });
            document.getElementById('changePasswordFormInternal').addEventListener('submit', handleChangePasswordSubmit);

            populateProcedureCheckboxes();
            document.getElementById('isStarClientCheckbox').addEventListener('change', updateTotalAgendamentoValue);
            document.getElementById('isPermutaCheckbox').addEventListener('change', togglePermutaDetailsAndRecalculate);
            document.getElementById('discountPercentage').addEventListener('input', updateTotalAgendamentoValue);
            
            document.getElementById('generateReportButton').addEventListener('click', () => {
                const reportControls = document.getElementById('reportControlsContainer');
                reportControls.style.display = reportControls.style.display === 'none' ? 'flex' : 'none';
                if(reportControls.style.display === 'flex') {
                    setupReportControls(); // Configura os listeners dos inputs de data/mês
                    generateAndDisplayEarningsReport(); 
                } else {
                    document.getElementById('reportSection').style.display = 'none';
                }
            });
            document.getElementById('downloadReportPdfButton').addEventListener('click', generateEarningsReportPDF);


            document.getElementById('appointmentFormInternal').addEventListener('submit', handleAppointmentFormSubmit);
            renderAppointmentsList();
        }
        
        function handleChangePasswordSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const currentPassword = form.currentPassword.value;
            const newPassword = form.newPassword.value;
            const confirmNewPassword = form.confirmNewPassword.value;
            const statusEl = document.getElementById('changePasswordStatus');
            statusEl.className = ''; 

            if (!currentPassword || !newPassword || !confirmNewPassword) {
                statusEl.textContent = "Todos os campos são obrigatórios.";
                statusEl.classList.add('error'); return;
            }
            if (newPassword !== confirmNewPassword) {
                statusEl.textContent = "As novas senhas não coincidem.";
                statusEl.classList.add('error'); return;
            }
            if (newPassword.length < 4) { 
                statusEl.textContent = "A nova senha deve ter pelo menos 4 caracteres.";
                statusEl.classList.add('error'); return;
            }
            if (loggedInUser.password !== currentPassword) {
                statusEl.textContent = "Senha atual incorreta.";
                statusEl.classList.add('error'); return;
            }

            appData.professionals[loggedInUser.id].password = newPassword;
            saveAppDataToLocalStorage();
            
            statusEl.textContent = "Senha alterada com sucesso!";
            statusEl.classList.add('success');
            form.reset();
            setTimeout(() => { 
                document.getElementById('changePasswordSectionInternal').style.display = 'none';
                statusEl.textContent = ''; 
            }, 2500);
        }


        function populateProcedureCheckboxes(selectedProceduresForEdit = []) {
            const container = document.getElementById('proceduresCheckboxesContainer');
            if (!container || !loggedInUser) return;
            container.innerHTML = '';

            loggedInUser.procedures.forEach(proc => {
                const itemId = `proc-${proc.name.replace(/\s+/g, '-')}-${Math.random().toString(36).substring(2,7)}`;
                const isChecked = selectedProceduresForEdit.some(p => p.name === proc.name);

                const div = document.createElement('div');
                div.classList.add('procedure-checkbox-item');
                div.innerHTML = `
                    <input type="checkbox" id="${itemId}" name="procedures" value="${proc.name}" data-value="${proc.value}" ${isChecked ? 'checked' : ''}>
                    <label for="${itemId}">${proc.name} <span class="procedure-value-text">(R$ ${Number(proc.value).toFixed(2)})</span></label>
                `;
                container.appendChild(div);
            });
            
            const checkboxes = container.querySelectorAll('input[type="checkbox"][name="procedures"]');
            checkboxes.forEach(cb => {
                cb.addEventListener('change', updateTotalAgendamentoValue);
            });
            updateTotalAgendamentoValue(); 
        }

        function togglePermutaDetailsAndRecalculate() {
            const permutaDetailsContainer = document.getElementById('permutaDetailsContainer');
            const isPermuta = document.getElementById('isPermutaCheckbox').checked;
            const discountInput = document.getElementById('discountPercentage');
            const isStarClientCheckbox = document.getElementById('isStarClientCheckbox');

            if (isPermuta) {
                permutaDetailsContainer.style.display = 'block';
                discountInput.value = 0; 
                discountInput.disabled = true;
                isStarClientCheckbox.checked = false; 
                isStarClientCheckbox.disabled = true;
            } else {
                permutaDetailsContainer.style.display = 'none';
                document.getElementById('permutaValorEstimado').value = ''; // Limpa campos de permuta
                document.getElementById('permutaDescricao').value = '';
                discountInput.disabled = false;
                isStarClientCheckbox.disabled = false;
            }
            updateTotalAgendamentoValue();
        }

        function updateTotalAgendamentoValue() {
            const container = document.getElementById('proceduresCheckboxesContainer');
            const totalDisplay = document.getElementById('totalAgendamentoValueDisplay');
            const discountInput = document.getElementById('discountPercentage');
            const isStarClientCheckbox = document.getElementById('isStarClientCheckbox');
            const isPermutaCheckbox = document.getElementById('isPermutaCheckbox');

            if (!container || !totalDisplay || !discountInput || !isStarClientCheckbox || !isPermutaCheckbox) return {};

            let currentRawTotal = 0;
            const checkboxes = container.querySelectorAll('input[type="checkbox"][name="procedures"]:checked');
            checkboxes.forEach(cb => {
                currentRawTotal += parseFloat(cb.dataset.value || 0);
            });

            const isStarClient = isStarClientCheckbox.checked;
            const isPermuta = isPermutaCheckbox.checked;
            let discountPercentage = parseFloat(discountInput.value) || 0;
            if (discountPercentage < 0) discountPercentage = 0;
            if (discountPercentage > 100) discountPercentage = 100;
            discountInput.value = discountPercentage; 

            let valueAfterStarDiscount = currentRawTotal;
            if (isStarClient && !isPermuta) {
                valueAfterStarDiscount = currentRawTotal * 0.80; // 20% de desconto Star
            }

            let finalTotal;
            let displayText = "";

            if (isPermuta) {
                finalTotal = 0;
                displayText = `Permuta (Preencha detalhes abaixo)`;
                // discountInput e isStarClientCheckbox já foram desabilitados em togglePermutaDetailsAndRecalculate
            } else {
                const additionalDiscountAmount = valueAfterStarDiscount * (discountPercentage / 100);
                finalTotal = valueAfterStarDiscount - additionalDiscountAmount;
                
                displayText = `Subtotal: R$ ${currentRawTotal.toFixed(2)}`;
                if (isStarClient) {
                    displayText += ` - Star (20%): R$ ${valueAfterStarDiscount.toFixed(2)}`;
                }
                if (discountPercentage > 0) {
                    displayText += ` - Desc. Adic. (${discountPercentage}%): R$ ${finalTotal.toFixed(2)}`;
                } else if (isStarClient && discountPercentage === 0) {
                     displayText = `Subtotal: R$ ${currentRawTotal.toFixed(2)} - Star (20%): R$ ${finalTotal.toFixed(2)}`;
                } else if (!isStarClient && discountPercentage === 0) {
                     displayText = `Valor Final: R$ ${finalTotal.toFixed(2)}`;
                } else { // Caso geral se houver desconto adicional
                     displayText = `Valor Final: R$ ${finalTotal.toFixed(2)}`;
                }
            }
            
            totalDisplay.textContent = displayText;
            return { 
                rawTotal: currentRawTotal, 
                finalTotal: finalTotal, 
                discountPercentage: isPermuta ? 0 : discountPercentage, 
                isPermuta: isPermuta,
                isStarClient: isStarClient && !isPermuta 
            };
        }


        function handleAppointmentFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const clientName = form.clientName.value.trim();
            const date = form.appointmentDate.value;
            const time = form.appointmentTime.value;
            const notes = form.notes.value.trim();
            const editingId = form.editingAppointmentId.value;

            const isStarClient = document.getElementById('isStarClientCheckbox').checked;
            const isPermuta = document.getElementById('isPermutaCheckbox').checked;
            let discountPercentage = parseFloat(document.getElementById('discountPercentage').value) || 0;
            let permutaValorEstimado = 0;
            let permutaDescricao = "";
            const naoCobrarAdiantamento = document.getElementById('naoCobrarAdiantamentoCheckbox').checked;


            if (isPermuta) {
                discountPercentage = 0; 
                permutaValorEstimado = parseFloat(document.getElementById('permutaValorEstimado').value) || 0;
                permutaDescricao = document.getElementById('permutaDescricao').value.trim();
                if (permutaValorEstimado <= 0 || !permutaDescricao) {
                    alert("Para permuta, o valor estimado e a descrição da troca são obrigatórios.");
                    return;
                }
            }


            const selectedProcedureElements = document.querySelectorAll('#proceduresCheckboxesContainer input[name="procedures"]:checked');
            const selectedProcedures = Array.from(selectedProcedureElements).map(cb => {
                return {
                    name: cb.value,
                    value: parseFloat(cb.dataset.value || 0)
                };
            });

            if (!clientName || !date || !time || selectedProcedures.length === 0) {
                alert("Preencha Cliente, Data, Hora e selecione ao menos um Procedimento."); return;
            }
            
            const calculationResult = updateTotalAgendamentoValue(); 

            const appointmentData = {
                professional: loggedInUser.id, clientName, date, time,
                procedures: selectedProcedures,
                totalValue: calculationResult.rawTotal,
                isStarClient: calculationResult.isStarClient,
                discountPercentage: calculationResult.discountPercentage,
                isPermuta: calculationResult.isPermuta,
                permutaValorEstimado: isPermuta ? permutaValorEstimado : 0,
                permutaDescricao: isPermuta ? permutaDescricao : "",
                naoCobrarAdiantamento: naoCobrarAdiantamento,
                finalValue: calculationResult.finalTotal,
                notes, 
                concluido: false, 
                cancelado: false
            };


            if (editingId) {
                const index = appData.appointments.findIndex(app => app.id === editingId);
                if (index > -1) {
                    appData.appointments[index] = { ...appData.appointments[index], ...appointmentData };
                }
                form.saveAppointmentButtonInternal.textContent = 'Salvar Agendamento';
            } else {
                appData.appointments.push({
                    id: 'app-' + Date.now() + '-' + Math.random().toString(36).substring(2,7),
                    ...appointmentData
                });
            }
            saveAppDataToLocalStorage();
            renderAppointmentsList();
            form.reset(); 
            document.querySelectorAll('#proceduresCheckboxesContainer input[name="procedures"]').forEach(cb => cb.checked = false); 
            document.getElementById('isStarClientCheckbox').checked = false;
            document.getElementById('isPermutaCheckbox').checked = false;
            document.getElementById('discountPercentage').value = 0;
            document.getElementById('naoCobrarAdiantamentoCheckbox').checked = false;
            togglePermutaDetailsAndRecalculate(); 
            form.editingAppointmentId.value = '';
            showStatusMessage("Agendamento salvo!", "success");
        }

        function renderAppointmentsList() {
            const container = document.getElementById('appointmentsContainerInternal');
            if (!container || !loggedInUser || loggedInUser.isAdmin) return;
            container.innerHTML = '';

            const userAppointments = appData.appointments
                .filter(app => app.professional === loggedInUser.id)
                .sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));

            if (userAppointments.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding:15px; color:var(--text-secondary-feminine);">Nenhum agendamento.</p>';
                return;
            }

            userAppointments.forEach(app => {
                const item = document.createElement('div');
                item.classList.add('appointment-item');
                if (app.concluido) item.classList.add('concluido');
                if (app.cancelado) item.classList.add('cancelado');
                if (app.isPermuta) item.classList.add('permuta');
                if (app.isStarClient && !app.isPermuta) item.classList.add('star-client-discount');
                
                let proceduresHTML = '<ul class="procedure-list-display">';
                (app.procedures || []).forEach(p => {
                    proceduresHTML += `<li>${p.name} <span class="procedure-value-text">(R$ ${Number(p.value).toFixed(2)})</span></li>`;
                });
                proceduresHTML += '</ul>';
                
                let paymentInfoHTML = '';
                if (app.isPermuta) {
                    paymentInfoHTML = `<p class="permuta-info"><strong>Permuta:</strong> ${app.permutaDescricao || 'N/A'} (Valor Estimado: R$ ${Number(app.permutaValorEstimado).toFixed(2)})</p>`;
                } else {
                    paymentInfoHTML = `<p class="total-value-display">Valor a Pagar: R$ ${Number(app.finalValue).toFixed(2)}</p>`;
                    if (app.isStarClient) {
                         paymentInfoHTML += `<p class="star-client-info">✨ Cliente Star! (Desconto de 20% aplicado sobre R$ ${Number(app.totalValue).toFixed(2)})</p>`;
                    }
                    if (app.discountPercentage > 0) {
                        const valueBeforeAdditionalDiscount = app.isStarClient ? Number(app.totalValue) * 0.8 : Number(app.totalValue);
                        paymentInfoHTML += `<p class="discount-info">(+ ${app.discountPercentage}% desc. adicional sobre R$ ${valueBeforeAdditionalDiscount.toFixed(2)})</p>`;
                    }
                }


                item.innerHTML = `
                    <div class="appointment-details">
                        <p><strong>Cliente:</strong> ${app.clientName}</p>
                        <p><strong>Data:</strong> ${new Date(app.date + 'T00:00:00').toLocaleDateString('pt-BR')} <strong>Hora:</strong> ${app.time}</p>
                        <p><strong>Procedimentos:</strong></p>
                        ${proceduresHTML}
                        ${paymentInfoHTML}
                        ${app.notes ? `<p><strong>Obs:</strong> <i>${app.notes}</i></p>` : ''}
                    </div>
                    <div class="appointment-actions">
                        <button class="edit-btn" data-id="${app.id}" ${app.concluido || app.cancelado ? 'disabled' : ''}>Editar</button>
                        <button class="delete-btn" data-id="${app.id}">Excluir</button>
                        <button class="toggle-concluido-btn ${app.concluido ? 'concluido' : ''}" data-id="${app.id}" ${app.cancelado ? 'disabled' : ''}>
                            ${app.concluido ? 'Reabrir' : 'Concluir'}
                        </button>
                        <button class="toggle-cancelado-btn ${app.cancelado ? 'cancelado' : ''}" data-id="${app.id}" ${app.concluido ? 'disabled' : ''}>
                            ${app.cancelado ? 'Reativar' : 'Cancelar'}
                        </button>
                        <button class="pdf-btn" data-id="${app.id}">Gerar PDF</button>
                    </div>`;
                container.appendChild(item);
            });

            container.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', handleEditAppointment));
            container.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', handleDeleteAppointment));
            container.querySelectorAll('.toggle-concluido-btn').forEach(b => b.addEventListener('click', handleToggleConcluido));
            container.querySelectorAll('.toggle-cancelado-btn').forEach(b => b.addEventListener('click', handleToggleCancelado));
            container.querySelectorAll('.pdf-btn').forEach(b => b.addEventListener('click', (e) => generateAppointmentPDF(e.target.dataset.id)));
        }

        function handleEditAppointment(event) {
            const appointmentId = event.target.dataset.id;
            const appToEdit = appData.appointments.find(app => app.id === appointmentId);
            const form = document.getElementById('appointmentFormInternal');
            if (appToEdit && form) {
                form.clientName.value = appToEdit.clientName;
                form.appointmentDate.value = appToEdit.date;
                form.appointmentTime.value = appToEdit.time;
                form.notes.value = appToEdit.notes || '';
                form.editingAppointmentId.value = appointmentId;
                form.saveAppointmentButtonInternal.textContent = 'Atualizar Agendamento';
                
                document.getElementById('isStarClientCheckbox').checked = appToEdit.isStarClient || false;
                document.getElementById('discountPercentage').value = appToEdit.discountPercentage || 0;
                const isPermutaCheckbox = document.getElementById('isPermutaCheckbox');
                isPermutaCheckbox.checked = appToEdit.isPermuta || false;
                document.getElementById('naoCobrarAdiantamentoCheckbox').checked = appToEdit.naoCobrarAdiantamento || false;
                
                if(appToEdit.isPermuta) {
                    document.getElementById('permutaValorEstimado').value = appToEdit.permutaValorEstimado || 0;
                    document.getElementById('permutaDescricao').value = appToEdit.permutaDescricao || "";
                }
                togglePermutaDetailsAndRecalculate(); 

                const selectedProceduresForEdit = appToEdit.procedures || [];
                populateProcedureCheckboxes(selectedProceduresForEdit); 
                
                form.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function handleDeleteAppointment(event) {
            const appointmentId = event.target.dataset.id;
            if (confirm("Excluir este agendamento?")) {
                appData.appointments = appData.appointments.filter(app => app.id !== appointmentId);
                saveAppDataToLocalStorage();
                renderAppointmentsList();
                showStatusMessage("Agendamento excluído.", "info");
            }
        }

        function handleToggleConcluido(event) {
            const appointmentId = event.target.dataset.id;
            const index = appData.appointments.findIndex(app => app.id === appointmentId);
            if (index > -1) {
                if (appData.appointments[index].cancelado) {
                    showStatusMessage("Não pode concluir um serviço cancelado. Reative-o primeiro.", "error"); return;
                }
                appData.appointments[index].concluido = !appData.appointments[index].concluido;
                saveAppDataToLocalStorage();
                renderAppointmentsList();
                showStatusMessage(`Agendamento ${appData.appointments[index].concluido ? 'concluído' : 'reaberto'}.`, "info");
            }
        }
        
        function handleToggleCancelado(event) {
            const appointmentId = event.target.dataset.id;
            const index = appData.appointments.findIndex(app => app.id === appointmentId);
            if (index > -1) {
                if (appData.appointments[index].concluido) {
                    showStatusMessage("Não pode cancelar um serviço concluído. Reabra-o primeiro.", "error"); return;
                }
                appData.appointments[index].cancelado = !appData.appointments[index].cancelado;
                saveAppDataToLocalStorage();
                renderAppointmentsList();
                showStatusMessage(`Agendamento ${appData.appointments[index].cancelado ? 'cancelado' : 'reativado'}.`, "info");
            }
        }
        
        // --- Relatórios ---
        function setupReportControls() {
            const reportTypeSelect = document.getElementById('reportType');
            const reportDateInput = document.getElementById('reportDateInput');
            const reportMonthInput = document.getElementById('reportMonthInput');

            function updateReportInputsVisibility() {
                const type = reportTypeSelect.value;
                reportDateInput.style.display = type === 'diario' ? 'inline-block' : 'none';
                reportMonthInput.style.display = type === 'mensal' ? 'inline-block' : 'none';
                generateAndDisplayEarningsReport(); 
            }

            reportTypeSelect.removeEventListener('change', updateReportInputsVisibility); // Evita duplicados
            reportDateInput.removeEventListener('change', generateAndDisplayEarningsReport);
            reportMonthInput.removeEventListener('change', generateAndDisplayEarningsReport);

            reportTypeSelect.addEventListener('change', updateReportInputsVisibility);
            reportDateInput.addEventListener('change', generateAndDisplayEarningsReport);
            reportMonthInput.addEventListener('change', generateAndDisplayEarningsReport);
            
            const today = new Date();
            const todayISO = today.toISOString().slice(0, 10);
            reportDateInput.value = todayISO;
            reportMonthInput.value = todayISO.slice(0, 7);

            updateReportInputsVisibility(); 
        }


        function getFilteredAppointmentsForReport() {
            const reportType = document.getElementById('reportType').value;
            const reportDate = document.getElementById('reportDateInput').value; 
            const reportMonth = document.getElementById('reportMonthInput').value; 

            return appData.appointments.filter(app => {
                if (app.professional !== loggedInUser.id || !app.concluido || app.cancelado) {
                    return false;
                }
                if (reportType === 'diario') {
                    return app.date === reportDate;
                } else if (reportType === 'mensal') {
                    return app.date.startsWith(reportMonth);
                }
                return true; // Para 'total'
            });
        }


        function generateAndDisplayEarningsReport() {
            const reportSection = document.getElementById('reportSection');
            if (!reportSection || !loggedInUser || loggedInUser.isAdmin) return;

            const filteredAppointments = getFilteredAppointmentsForReport();

            if (filteredAppointments.length === 0) {
                reportSection.innerHTML = "<h5>Relatório de Ganhos</h5><p>Nenhum serviço correspondente aos filtros para gerar relatório.</p>";
                reportSection.style.display = 'block';
                return;
            }

            let granTotalGanhos = 0;
            let permutasCount = 0;
            let permutasValorTotalEstimado = 0;
            const reportTypeDisplay = document.getElementById('reportType').options[document.getElementById('reportType').selectedIndex].text;


            let reportHTML = `
                <h5>Relatório de Ganhos - ${loggedInUser.fullName} (${reportTypeDisplay})</h5>
                <table>
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Data/Hora</th>
                            <th>Procedimentos</th>
                            <th>Valor Pago (R$)</th>
                            <th>Obs.</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredAppointments.sort((a,b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time))
                .forEach(app => {
                const dataHora = new Date(app.date + 'T' + app.time).toLocaleString('pt-BR', {
                    day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                
                let obsText = "";
                let valorLinha;

                if (app.isPermuta) {
                    valorLinha = 0; 
                    obsText = `Permuta: ${app.permutaDescricao} (Est: R$ ${Number(app.permutaValorEstimado).toFixed(2)})`;
                    permutasCount++;
                    permutasValorTotalEstimado += Number(app.permutaValorEstimado || 0);
                } else {
                    valorLinha = Number(app.finalValue) || 0;
                    granTotalGanhos += valorLinha;
                    if (app.isStarClient) {
                        obsText += "✨ Star! ";
                    }
                    if (app.discountPercentage > 0) {
                        obsText += `Desc: ${app.discountPercentage}%`;
                    }
                }
                
                let proceduresListHTML = "<ul class='procedure-list-display'>"; 
                (app.procedures || []).forEach(p => {
                    proceduresListHTML += `<li>${p.name} <span class="procedure-value-text">(R$ ${Number(p.value).toFixed(2)})</span></li>`;
                });
                proceduresListHTML += "</ul>";

                reportHTML += `
                    <tr class="${app.isPermuta ? 'permuta-item' : ''}">
                        <td>${app.clientName}</td>
                        <td>${dataHora}</td>
                        <td>${proceduresListHTML}</td>
                        <td>${valorLinha.toFixed(2)}</td>
                        <td>${obsText.trim()}</td>
                    </tr>
                `;
            });

            reportHTML += `
                    </tbody>
                </table>
                <div class="total-ganhos">Total de Ganhos (Monetário): R$ ${granTotalGanhos.toFixed(2)}</div>
            `;
            if(permutasCount > 0){
                reportHTML += `<div class="total-ganhos" style="font-size:1em; color: var(--permuta-color);">Total de Permutas: ${permutasCount} (Valor Estimado Total: R$ ${permutasValorTotalEstimado.toFixed(2)})</div>`;
            }
            reportSection.innerHTML = reportHTML;
            reportSection.style.display = 'block';
        }

        function generateEarningsReportPDF() {
            const filteredAppointments = getFilteredAppointmentsForReport();
            if (!loggedInUser || filteredAppointments.length === 0) {
                showStatusMessage("Nenhum dado para gerar PDF do relatório.", "info");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            
            const margin = 15;
            let currentY = margin + 10;
            const lineHeight = 6; // Reduzido para caber mais
            const smallLineHeight = 4;
            const tableCellPadding = 2;

            doc.setFont("helvetica", "bold");
            doc.setFontSize(16);
            doc.setTextColor(getComputedStyle(document.documentElement).getPropertyValue('--rose-gold-accent').trim());
            const reportTypeSelect = document.getElementById('reportType');
            const reportTypeDisplay = reportTypeSelect.options[reportTypeSelect.selectedIndex].text;
            
            let dateRangeText = "";
            if (reportTypeSelect.value === 'diario') {
                dateRangeText = ` - Data: ${new Date(document.getElementById('reportDateInput').value + 'T00:00:00').toLocaleDateString('pt-BR')}`;
            } else if (reportTypeSelect.value === 'mensal') {
                 const [year, month] = document.getElementById('reportMonthInput').value.split('-');
                 dateRangeText = ` - Mês: ${month}/${year}`;
            }


            doc.text(`Relatório de Ganhos (${reportTypeDisplay})${dateRangeText}`, doc.internal.pageSize.getWidth() / 2, currentY, { align: "center" });
            currentY += lineHeight;
            doc.setFontSize(12);
            doc.text(`Profissional: ${loggedInUser.fullName}`, doc.internal.pageSize.getWidth() / 2, currentY, { align: "center" });
            currentY += lineHeight * 1.5;


            doc.setFont("helvetica", "normal");
            doc.setFontSize(9); // Reduzir fonte da tabela
            doc.setTextColor(getComputedStyle(document.documentElement).getPropertyValue('--text-primary-feminine').trim());

            const tableHeaders = ["Cliente", "Data/Hora", "Procedimentos", "Valor Pago", "Obs."];
            const columnWidths = [35, 30, 65, 20, 30]; 
            
            function drawTableHeaders() {
                doc.setFont("helvetica", "bold");
                doc.setFillColor(getComputedStyle(document.documentElement).getPropertyValue('--primary-color-feminine').trim() + "33"); 
                doc.rect(margin, currentY, doc.internal.pageSize.getWidth() - (margin * 2), lineHeight + tableCellPadding, 'F');
                let currentX = margin + tableCellPadding;
                tableHeaders.forEach((header, index) => {
                    doc.text(header, currentX, currentY + lineHeight * 0.7);
                    currentX += columnWidths[index];
                });
                currentY += lineHeight + tableCellPadding + 1;
                doc.setFont("helvetica", "normal");
            }
            drawTableHeaders();


            let granTotalGanhos = 0;
            let permutasCount = 0;
            let permutasValorTotalEstimado = 0;

            filteredAppointments.forEach(app => {
                if (currentY > doc.internal.pageSize.getHeight() - margin * 3) { 
                    doc.addPage();
                    currentY = margin;
                    drawTableHeaders();
                }

                const dataHora = new Date(app.date + 'T' + app.time).toLocaleString('pt-BR', {day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit'});
                let obsText = "";
                let valorLinha;

                if (app.isPermuta) {
                    valorLinha = 0; 
                    obsText = `Permuta: ${app.permutaDescricao.substring(0,20)}${app.permutaDescricao.length > 20 ? '...' : ''} (Est: R$${Number(app.permutaValorEstimado).toFixed(2)})`;
                    permutasCount++;
                    permutasValorTotalEstimado += Number(app.permutaValorEstimado || 0);
                } else {
                    valorLinha = Number(app.finalValue) || 0;
                    granTotalGanhos += valorLinha;
                    if (app.isStarClient) obsText += "Star! ";
                    if (app.discountPercentage > 0) obsText += `Desc: ${app.discountPercentage}%`;
                }
                
                let proceduresTextArray = (app.procedures || []).map(p => `${p.name.substring(0,15)}${p.name.length > 15 ? '...' : ''} (R$${Number(p.value).toFixed(2)})`);
                
                const rowData = [
                    app.clientName, dataHora, "", valorLinha.toFixed(2), obsText.trim()
                ];
                
                let initialYForRow = currentY;
                let maxLinesInRow = 1;

                // Desenha os primeiros campos
                let currentX = margin + tableCellPadding;
                doc.text(app.clientName, currentX, currentY + smallLineHeight * 0.8);
                currentX += columnWidths[0];
                doc.text(dataHora, currentX, currentY + smallLineHeight * 0.8);
                currentX += columnWidths[1];
                
                // Desenha procedimentos (pode ter múltiplas linhas)
                let procY = currentY + smallLineHeight * 0.8;
                proceduresTextArray.forEach(procText => {
                    if (procY > doc.internal.pageSize.getHeight() - margin * 2) { // Nova página se procedimentos estourarem
                        doc.addPage(); currentY = margin; drawTableHeaders(); procY = currentY + smallLineHeight * 0.8; initialYForRow = currentY;
                    }
                    doc.text(procText, currentX, procY);
                    procY += smallLineHeight * 0.9;
                });
                maxLinesInRow = Math.max(maxLinesInRow, proceduresTextArray.length || 1);
                currentX += columnWidths[2];

                // Desenha os últimos campos alinhados com a primeira linha dos procedimentos
                doc.text(valorLinha.toFixed(2), currentX, initialYForRow + smallLineHeight * 0.8);
                currentX += columnWidths[3];
                const obsLines = doc.splitTextToSize(obsText.trim(), columnWidths[4] - (tableCellPadding * 2));
                doc.text(obsLines, currentX, initialYForRow + smallLineHeight * 0.8);
                maxLinesInRow = Math.max(maxLinesInRow, obsLines.length || 1);


                currentY = initialYForRow + (maxLinesInRow * smallLineHeight * 0.9) + tableCellPadding;
                doc.setDrawColor(getComputedStyle(document.documentElement).getPropertyValue('--border-color-feminine').trim());
                doc.line(margin, currentY -1, doc.internal.pageSize.getWidth() - margin, currentY -1);

            });
            
            currentY += lineHeight;
            if (currentY > doc.internal.pageSize.getHeight() - margin * 2) { doc.addPage(); currentY = margin; }

            doc.setFont("helvetica", "bold");
            doc.setFontSize(10);
            doc.text(`Total de Ganhos (Monetário): R$ ${granTotalGanhos.toFixed(2)}`, doc.internal.pageSize.getWidth() - margin, currentY, { align: "right" });
            currentY += lineHeight;

            if(permutasCount > 0){
                if (currentY > doc.internal.pageSize.getHeight() - margin * 2) { doc.addPage(); currentY = margin; }
                doc.setFontSize(9);
                doc.setTextColor(getComputedStyle(document.documentElement).getPropertyValue('--permuta-color').trim());
                doc.text(`Total de Permutas: ${permutasCount} (Valor Estimado Total: R$ ${permutasValorTotalEstimado.toFixed(2)})`, doc.internal.pageSize.getWidth() - margin, currentY, { align: "right" });
            }

            const fileName = `Relatorio_Ganhos_${loggedInUser.id}_${reportTypeDisplay}_${new Date().toISOString().slice(0,10)}.pdf`;
            doc.save(fileName);
            showStatusMessage("Relatório PDF gerado!", "success");
        }


        function generateAppointmentPDF(appointmentId) {
            const app = appData.appointments.find(a => a.id === appointmentId);
            if (!app) {
                showStatusMessage("Agendamento não encontrado para gerar PDF.", "error");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const professional = appData.professionals[app.professional];

            const margin = 15;
            let currentY = margin + 10;
            const lineHeight = 7;
            const smallLineHeight = 5;

            doc.setFont("helvetica", "bold");
            doc.setFontSize(20);
            doc.setTextColor(getComputedStyle(document.documentElement).getPropertyValue('--rose-gold-accent').trim());
            doc.text("Comprovante de Agendamento", doc.internal.pageSize.getWidth() / 2, currentY, { align: "center" });
            currentY += lineHeight * 2.5;

            doc.setFont("helvetica", "normal");
            doc.setFontSize(14);
            doc.setTextColor(getComputedStyle(document.documentElement).getPropertyValue('--text-primary-feminine').trim());
            doc.text("Espaço Bezerra", margin, currentY);
            currentY += lineHeight * 1.5;

            doc.setDrawColor(getComputedStyle(document.documentElement).getPropertyValue('--border-color-feminine').trim());
            doc.setLineWidth(0.3);
            doc.line(margin, currentY - (lineHeight * 0.5) , doc.internal.pageSize.getWidth() - margin, currentY - (lineHeight * 0.5));
            currentY += smallLineHeight * 1.5;


            doc.setFontSize(11);
            doc.text(`Cliente: ${app.clientName}`, margin, currentY);
            currentY += lineHeight;
            
            const dataHora = new Date(app.date + 'T' + app.time).toLocaleString('pt-BR', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
            doc.text(`Data e Hora: ${dataHora}`, margin, currentY);
            currentY += lineHeight;
            
            if (professional) {
                doc.text(`Profissional: ${professional.fullName} (${professional.area})`, margin, currentY); // Nome da profissional adicionado
                currentY += lineHeight;
            }
            currentY += smallLineHeight;

            doc.setFont("helvetica", "bold");
            doc.text("Procedimento(s):", margin, currentY);
            currentY += lineHeight * 0.8;
            doc.setFont("helvetica", "normal");

            (app.procedures || []).forEach(p => {
                doc.text(`- ${p.name}`, margin + 5, currentY);
                doc.text(`R$ ${Number(p.value).toFixed(2)}`, doc.internal.pageSize.getWidth() - margin - 30, currentY, { align: "right" });
                currentY += smallLineHeight * 1.3;
            });
            
            currentY += smallLineHeight * 0.5;
            doc.line(margin, currentY - (smallLineHeight * 0.8) , doc.internal.pageSize.getWidth() - margin, currentY - (smallLineHeight * 0.8));
            currentY += smallLineHeight * 1.5;

            doc.setFontSize(11);
            if (app.isPermuta) {
                doc.setFont("helvetica", "bold");
                doc.setTextColor(getComputedStyle(document.documentElement).getPropertyValue('--permuta-color').trim());
                doc.text("SERVIÇO REALIZADO VIA PERMUTA", margin, currentY);
                currentY += lineHeight * 0.8;
                doc.setFont("helvetica", "normal");
                doc.setTextColor(getComputedStyle(document.documentElement).getPropertyValue('--text-primary-feminine').trim());
                doc.text(`Descrição da Troca: ${app.permutaDescricao}`, margin, currentY);
                currentY += smallLineHeight;
                doc.text(`Valor Estimado da Permuta: R$ ${Number(app.permutaValorEstimado).toFixed(2)}`, margin, currentY);
                currentY += lineHeight;
            } else {
                if (app.isStarClient) {
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(12); // Tamanho maior para destaque
                    doc.setTextColor(getComputedStyle(document.documentElement).getPropertyValue('--star-client-color').trim());
                    doc.text("✨ Minha Cliente é uma Star! ✨", margin, currentY);
                    currentY += smallLineHeight * 1.8; // Mais espaço após
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(10);
                    doc.setTextColor(getComputedStyle(document.documentElement).getPropertyValue('--text-secondary-feminine').trim());
                    doc.text(`(Desconto especial de 20% aplicado sobre R$ ${Number(app.totalValue).toFixed(2)})`, margin, currentY);
                    currentY += smallLineHeight * 1.5;
                    doc.setFontSize(11);
                    doc.setTextColor(getComputedStyle(document.documentElement).getPropertyValue('--text-primary-feminine').trim());
                }
                if (app.discountPercentage > 0) {
                    doc.setFont("helvetica", "italic");
                    doc.setFontSize(10);
                    doc.setTextColor(getComputedStyle(document.documentElement).getPropertyValue('--accent-color-feminine').trim());
                    const valueAfterStar = app.isStarClient ? Number(app.totalValue) * 0.8 : Number(app.totalValue);
                    doc.text(`Subtotal (após desc. Star, se houver): R$ ${valueAfterStar.toFixed(2)}`, margin, currentY);
                    currentY += smallLineHeight * 1.2;
                    doc.text(`Desconto Adicional Aplicado: ${app.discountPercentage}% (R$ ${(valueAfterStar * (app.discountPercentage/100)).toFixed(2)})`, margin, currentY);
                    currentY += smallLineHeight * 1.5;
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(11);
                    doc.setTextColor(getComputedStyle(document.documentElement).getPropertyValue('--text-primary-feminine').trim());
                }
                doc.setFont("helvetica", "bold");
                doc.text("Valor Total a Pagar:", margin, currentY);
                doc.text(`R$ ${Number(app.finalValue).toFixed(2)}`, doc.internal.pageSize.getWidth() - margin, currentY, { align: "right" });
                currentY += lineHeight * 1.5;
            }

            if (app.notes) {
                doc.setFont("helvetica", "bold");
                doc.text("Observações:", margin, currentY);
                currentY += smallLineHeight;
                doc.setFont("helvetica", "normal");
                const notesLines = doc.splitTextToSize(app.notes, doc.internal.pageSize.getWidth() - (margin * 2));
                doc.text(notesLines, margin, currentY);
                currentY += notesLines.length * smallLineHeight;
            }
            
            if (!app.naoCobrarAdiantamento) {
                currentY += lineHeight * 0.8;
                if (currentY > doc.internal.pageSize.getHeight() - margin * 4) { doc.addPage(); currentY = margin; } // Verifica espaço antes da política

                doc.setDrawColor(getComputedStyle(document.documentElement).getPropertyValue('--border-color-feminine').trim());
                doc.line(margin, currentY - (smallLineHeight * 0.5) , doc.internal.pageSize.getWidth() - margin, currentY - (smallLineHeight * 0.5));
                currentY += smallLineHeight;

                doc.setFont("helvetica", "bold");
                doc.setFontSize(10);
                doc.setTextColor(getComputedStyle(document.documentElement).getPropertyValue('--rose-gold-accent').trim());
                doc.text("Política de Agendamento e Adiantamento:", margin, currentY);
                currentY += smallLineHeight * 1.2;

                doc.setFont("helvetica", "normal");
                doc.setFontSize(9);
                doc.setTextColor(getComputedStyle(document.documentElement).getPropertyValue('--text-secondary-feminine').trim());
                const politicaText = [
                    "Para dedicarmos seu horário com todo carinho, solicitamos um adiantamento de 30% do valor total do(s) serviço(s) agendado(s).",
                    "Este valor será, claro, abatido no dia do seu atendimento. Agradecemos imensamente sua compreensão e colaboração!",
                    "Sabemos que imprevistos acontecem! Remarcações ou cancelamentos podem ser feitos com até 48h de antecedência.",
                    "Nesse caso, seu adiantamento pode ser usado para um novo horário ou reembolsado.",
                    "Estamos ansiosas para te receber e realçar ainda mais sua beleza! 💕"
                ];
                politicaText.forEach(line => {
                    if (currentY > doc.internal.pageSize.getHeight() - margin) { doc.addPage(); currentY = margin; }
                    const lines = doc.splitTextToSize(line, doc.internal.pageSize.getWidth() - (margin * 2));
                    doc.text(lines, margin, currentY);
                    currentY += lines.length * smallLineHeight * 0.9;
                });
                 currentY += smallLineHeight;
            }


            currentY += lineHeight;
            if (currentY > doc.internal.pageSize.getHeight() - margin * 2) { 
                doc.addPage();
                currentY = margin;
            }


            doc.setFontSize(10);
            doc.setTextColor(getComputedStyle(document.documentElement).getPropertyValue('--text-secondary-feminine').trim());
            doc.text("Obrigada pela preferência!", doc.internal.pageSize.getWidth() / 2, currentY, { align: "center" });
            currentY += smallLineHeight * 1.5;
            doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, doc.internal.pageSize.getWidth() / 2, currentY, { align: "center" });


            const fileName = `Comprovante_EspacoBezerra_${app.clientName.replace(/\s+/g, '_')}_${app.date}.pdf`;
            doc.save(fileName);
            showStatusMessage("Comprovante PDF gerado!", "success");
        }


        // --- Funções do Painel Admin (mantidas e adaptadas como antes) ---
        function populateAdminPanel() {
            if (!loggedInUser || !loggedInUser.isAdmin) return;
            renderManageProfessionals();
            populateProfessionalSelectForProcedures();
            const selectProfForProc = document.getElementById('selectProfessionalForProcedures');
            selectProfForProc.removeEventListener('change', handleAdminSelectProfChange); 
            selectProfForProc.addEventListener('change', handleAdminSelectProfChange);
            
            const firstProfId = Object.keys(appData.professionals).find(id => !appData.professionals[id].isAdmin);
            if (firstProfId) {
                selectProfForProc.value = firstProfId;
                renderManageProcedures(firstProfId);
            } else {
                 document.getElementById('manageProceduresContainer').innerHTML = "<p style='color:var(--text-secondary-feminine);'>Nenhuma profissional cadastrada.</p>";
            }
        }
        function handleAdminSelectProfChange(e) {
            renderManageProcedures(e.target.value);
        }


        const addProfessionalForm = document.getElementById('addProfessionalForm');
        addProfessionalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = addProfessionalForm.newProfId.value.trim();
            const fullName = addProfessionalForm.newProfFullName.value.trim();
            const password = addProfessionalForm.newProfPassword.value;
            const area = addProfessionalForm.newProfArea.value;

            if (!id || !fullName || !password) {
                showStatusMessage("Preencha ID, Nome e Senha.", "error", true); return;
            }
            if (appData.professionals[id]) {
                showStatusMessage("ID de profissional já existe.", "error", true); return;
            }
            appData.professionals[id] = { id, fullName, password, area, isAdmin: false, procedures: [] };
            saveAppDataToLocalStorage();
            renderManageProfessionals();
            populateProfessionalSelectForProcedures();
            addProfessionalForm.reset();
            showStatusMessage("Profissional adicionada!", "success", true);
        });

        function renderManageProfessionals() {
            const container = document.getElementById('manageProfessionalsContainer');
            container.innerHTML = '<ul>'; 
            Object.values(appData.professionals).filter(p => !p.isAdmin).forEach(prof => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${prof.fullName} (ID: ${prof.id}, Área: ${prof.area})</span>
                    <div>
                        <input type="text" value="${prof.fullName}" data-id="${prof.id}" placeholder="Novo nome" style="max-width: 200px;">
                        <button data-id="${prof.id}" class="save-prof-name-btn std-button-feminine admin">Salvar Nome</button>
                    </div>
                `;
                container.querySelector('ul').appendChild(li);
            });
            container.querySelectorAll('.save-prof-name-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const profId = e.target.dataset.id;
                    const newNameInput = container.querySelector(`input[type="text"][data-id="${profId}"]`);
                    if (newNameInput && newNameInput.value.trim() && appData.professionals[profId]) {
                        appData.professionals[profId].fullName = newNameInput.value.trim();
                        saveAppDataToLocalStorage();
                        renderManageProfessionals();
                        populateProfessionalSelectForProcedures();
                        showStatusMessage("Nome atualizado.", "success", true);
                    }
                });
            });
        }

        function populateProfessionalSelectForProcedures() {
            const select = document.getElementById('selectProfessionalForProcedures');
            const currentVal = select.value;
            select.innerHTML = '<option value="">-- Selecione Profissional --</option>';
            Object.values(appData.professionals).filter(p => !p.isAdmin).forEach(prof => {
                const option = document.createElement('option');
                option.value = prof.id;
                option.textContent = prof.fullName;
                select.appendChild(option);
            });
            if (appData.professionals[currentVal] && !appData.professionals[currentVal].isAdmin) {
                select.value = currentVal;
            }
        }

        function renderManageProcedures(profId) {
            const container = document.getElementById('manageProceduresContainer');
            container.innerHTML = '';
            const professional = appData.professionals[profId];

            if (!professional || professional.isAdmin) {
                container.innerHTML = "<p style='color:var(--text-secondary-feminine);'>Selecione uma profissional.</p>"; return;
            }

            const ul = document.createElement('ul');
            if (professional.procedures.length === 0) {
                ul.innerHTML = "<li>Nenhum procedimento cadastrado.</li>";
            } else {
                professional.procedures.forEach((proc, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${proc.name}</span>
                        <div>
                            R$ <input type="number" class="procedure-value-input" value="${Number(proc.value).toFixed(2)}" step="0.01" min="0" data-prof-id="${profId}" data-proc-index="${index}">
                            <button class="save-proc-value-btn std-button-feminine admin" data-prof-id="${profId}" data-proc-index="${index}">Salvar</button>
                            <button class="delete-proc-btn std-button-feminine danger" data-prof-id="${profId}" data-proc-index="${index}">Excluir</button>
                        </div>
                    `;
                    ul.appendChild(li);
                });
            }
            container.appendChild(ul);
            container.querySelectorAll('.save-proc-value-btn').forEach(b => b.addEventListener('click', saveProcedureValue));
            container.querySelectorAll('.delete-proc-btn').forEach(b => b.addEventListener('click', deleteProcedure));
        }
        
        function saveProcedureValue(event) {
            const profId = event.target.dataset.profId;
            const procIndex = parseInt(event.target.dataset.procIndex);
            const professional = appData.professionals[profId];
            const valueInput = document.querySelector(`.procedure-value-input[data-prof-id="${profId}"][data-proc-index="${procIndex}"]`);

            if (professional && professional.procedures[procIndex] && valueInput) {
                const newValue = parseFloat(valueInput.value);
                if (!isNaN(newValue) && newValue >= 0) {
                    professional.procedures[procIndex].value = newValue;
                    saveAppDataToLocalStorage();
                    showStatusMessage("Valor atualizado!", "success", true);
                    renderManageProcedures(profId);
                } else {
                    showStatusMessage("Valor inválido.", "error", true);
                }
            }
        }
        
        function deleteProcedure(event) {
            const profId = event.target.dataset.profId;
            const procIndex = parseInt(event.target.dataset.procIndex);
            const professional = appData.professionals[profId];

            if (professional && professional.procedures[procIndex]) {
                if (confirm(`Excluir "${professional.procedures[procIndex].name}" para ${professional.fullName}?`)) {
                    professional.procedures.splice(procIndex, 1);
                    saveAppDataToLocalStorage();
                    renderManageProcedures(profId);
                    showStatusMessage("Procedimento excluído.", "info", true);
                }
            }
        }

        const addProcedureToProfessionalForm = document.getElementById('addProcedureToProfessionalForm');
        addProcedureToProfessionalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const selectedProfId = document.getElementById('selectProfessionalForProcedures').value;
            const procedureName = addProcedureToProfessionalForm.newProcedureName.value.trim();
            const procedureValue = parseFloat(addProcedureToProfessionalForm.newProcedureValue.value);

            if (!selectedProfId) { showStatusMessage("Selecione uma profissional.", "error", true); return; }
            if (!procedureName) { showStatusMessage("Nome do procedimento é obrigatório.", "error", true); return; }
            if (isNaN(procedureValue) || procedureValue < 0) { showStatusMessage("Valor inválido.", "error", true); return; }

            const professional = appData.professionals[selectedProfId];
            if (professional && !professional.isAdmin) {
                if (professional.procedures.find(p => p.name.toLowerCase() === procedureName.toLowerCase())) {
                    showStatusMessage("Procedimento já existe.", "error", true); return;
                }
                professional.procedures.push({ name: procedureName, value: procedureValue });
                saveAppDataToLocalStorage();
                renderManageProcedures(selectedProfId);
                addProcedureToProfessionalForm.reset();
                addProcedureToProfessionalForm.newProcedureValue.value = "0.00";
                showStatusMessage("Procedimento adicionado!", "success", true);
            }
        });

        const exportDataButton = document.getElementById('exportDataButton');
        exportDataButton.addEventListener('click', () => {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `espaco_bezerra_backup_${new Date().toISOString().slice(0,10)}.json`;
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            showStatusMessage("Backup exportado. Salve o arquivo JSON.", "success", true);
        });

        const importDataButton = document.getElementById('importDataButton');
        const importDataFile = document.getElementById('importDataFile');
        importDataButton.addEventListener('click', () => {
            const file = importDataFile.files[0];
            if (!file) { showStatusMessage("Selecione um arquivo.", "error", true); return; }
            if (!confirm("ATENÇÃO: Isso substituirá TODOS os dados atuais. Continuar?")) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (importedData && typeof importedData.professionals === 'object' && Array.isArray(importedData.appointments)) {
                        appData = importedData;
                        saveAppDataToLocalStorage();
                        loadAppDataFromLocalStorage(); 
                        
                        if (loggedInUser && loggedInUser.isAdmin && appData.professionals[loggedInUser.id] && appData.professionals[loggedInUser.id].isAdmin) {
                             populateAdminPanel();
                        } else {
                            loggedInUser = null; 
                            showLoginSection();
                        }
                        showStatusMessage("Dados importados com sucesso!", "success", true);
                    } else {
                        showStatusMessage("Arquivo de backup inválido.", "error", true);
                    }
                } catch (e) {
                    showStatusMessage("Erro ao processar arquivo.", "error", true);
                }
            };
            reader.readAsText(file);
            importDataFile.value = '';
        });

        // --- Inicialização da Aplicação ---
        loadAppDataFromLocalStorage();
        loadViewModePreference(); 
        showLoginSection(); 

    </script>
</body>
</html>

